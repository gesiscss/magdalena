services:

  sphinx:
    image: docker-private-releases.gesis.intra/gesis/methods-hub/sphinx/sphinx:7.2.6-make
    command: sphinx-autobuild --host 0.0.0.0 source build
    volumes:
      - type: bind
        source: docs/source
        target: /docs/source
    expose:
      - "8000"
    ports:
      - "8000:8000"

  swagger-editor:
    image: swaggerapi/swagger-editor:v4.12.1
    environment:
      SWAGGER_FILE: /var/magdalena/openapi/magdalena.yaml
    volumes:
      - type: bind
        source: docs/source/_static/openapi
        target: /var/magdalena/openapi
    expose:
      - "8080"
    ports:
      - "8080:8080"

  magdalena:
    build:
      context: .
      target: dev
    environment:
      MAGDALENA_SHARED_DIR: /tmp/magdalena-shared-volume
      MAGDALENA_GRAPHQL_TARGET_URL: http://localhost/graphql
      MAGDALENA_GRAPHQL_TARGET_TOKEN: 123456
      LOG_LEVEL: debug
    volumes:
      - type: bind
        source: .
        target: /var/magdalena
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        # This must be the same as MAGDALENA_SHARED_DIR
        # because of Docker outside of Docker
        source: /tmp/magdalena-shared-volume
        target: /tmp/magdalena-shared-volume
    expose:
      - "5000"
    ports:
      - "5000:5000"
    command: flask run --host 0.0.0.0 --port 5000 --reload --debug --debugger
