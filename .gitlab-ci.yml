stages:
  - config
  - prepare
  - test
  - release

Assign Docker image tag:
  stage: config
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
      variables:
        DOCKER_IMAGE_TAG: $CI_COMMIT_TAG
        DOCKER_TARGET: prod
        DOCKER_REGISTRY: docker-private-releases.gesis.intra/gesis
    - if:  $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == 'main'
      variables:
        DOCKER_IMAGE_TAG: latest
        DOCKER_TARGET: dev
        DOCKER_REGISTRY: docker-private-snapshots.gesis.intra/gesis
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - Dockerfile
      variables:
        DOCKER_IMAGE_TAG: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
        DOCKER_TARGET: dev
        DOCKER_REGISTRY: docker-private-snapshots.gesis.intra/gesis
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        DOCKER_IMAGE_TAG: latest
        DOCKER_TARGET: dev
        DOCKER_REGISTRY: docker-private-snapshots.gesis.intra/gesis
  script:
    - rm -f docker.env
    - echo "DOCKER_IMAGE_TAG=${DOCKER_IMAGE_TAG}" >> docker.env
    - echo "DOCKER_TARGET=${DOCKER_TARGET}" >> docker.env
    - echo "DOCKER_REGISTRY=${DOCKER_REGISTRY}" >> docker.env
  artifacts:
    reports:
      dotenv: docker.env

build documentation:
  image: docker-private-releases.gesis.intra/gesis/methods-hub/sphinx/sphinx
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - docs/source/**/*
  script:
    - cd docs
    - make html
  artifacts:
    paths:
      - docs/build

pages:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
  dependencies:
    - build documentation
  script:
    - mkdir -p public
    - mv build/html/* public
  artifacts:
    paths:
      - public

Build container:
  stage: prepare
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == 'main'
      changes:
        - Dockerfile
        - requirements*.txt
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - Dockerfile
        - requirements*.txt
  image: docker-private.gesis.intra/gesis/dc:5.7
  services:
    - name:  docker-private.gesis.intra/gesis/dind:5.5
      alias: docker
  script:
    - docker build --target ${DOCKER_TARGET} --no-cache --pull -t ${DOCKER_REGISTRY}/${CI_PROJECT_PATH}/${DOCKER_TARGET}:${DOCKER_IMAGE_TAG} .
    - docker push ${DOCKER_REGISTRY}/${CI_PROJECT_PATH}/${DOCKER_TARGET}:${DOCKER_IMAGE_TAG}

Verify code style:
  stage: test
  rules:
    - if: ($CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == 'main') || $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - '**/*.py'
  image: ${DOCKER_REGISTRY}/${CI_PROJECT_PATH}/${DOCKER_TARGET}:${DOCKER_IMAGE_TAG}
  script:
    - black .

Run test:
  tags:
    - docker
    - methodshub
  stage: test
  rules:
    - if: ($CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == 'main') || $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - '**/*.py'
  image: ${DOCKER_REGISTRY}/${CI_PROJECT_PATH}/${DOCKER_TARGET}:${DOCKER_IMAGE_TAG}
  variables:
    MAGDALENA_SHARED_DIR: /tmp/magdalena-shared-volume
  script:
    - mkdir $MAGDALENA_SHARED_DIR
    - pytest .
